USE DATABASE SALES;
USE ROLE SYSADMIN;

--CUSTOMER SOURCE
create or replace view SALES.GOLD.VW_NEW_CUSTOMER_SRC(
	CST_ID,
	CST_KEY,
	CST_FIRSTNAME,
	CST_LASTNAME,
	BDATE,
	CST_MARITAL_STATUS,
	CST_GNDR_DERIVED,
	CST_CREATE_DATE,
	CST_LOYALTY_JOIN_DATE,
	STORE_KEY,
	DWH_STATUS,
	DWH_START_DATE,
	DWH_END_DATE,
	DWH_CREATE_DATE
) as
    SELECT
        CI.CST_ID,
        CI.CST_KEY, -- CRM is the master so CRM_CUST_INFO.CST_KEY trumps ERP_CUST_AZ12.CID
        CI.CST_FIRSTNAME,
        CI.CST_LASTNAME,
        CA.BDATE,
        CI.CST_MARITAL_STATUS,
        CASE
            WHEN CI.CST_GNDR != 'N/A' THEN CI.CST_GNDR
            ELSE COALESCE(CA.GEN, 'N/A')
        END AS CST_GNDR_derived,
        CI.CST_CREATE_DATE,
        CI.CST_LOYALTY_JOIN_DATE,
        DS.STORE_KEY,
        'Current' AS DWH_STATUS,
        CAST(GETDATE() AS DATE) AS DWH_START_DATE,
        '9999-12-31' AS DWH_END_DATE,
        GETDATE() AS DWH_CREATE_DATE
    FROM
        SALES.SILVER.CRM_CUST_INFO CI
        LEFT JOIN SALES.SILVER.ERP_CUST_AZ12 CA
        ON CI.CST_KEY = RIGHT(CA.CID,LEN(CA.CID)-4)
        LEFT JOIN SALES.GOLD.DIM_STORE DS
        ON CI.CST_PREF_STORE = DS.STORE_ID;

------


--PRODUCT SOURCE
CREATE OR REPLACE VIEW SALES.GOLD.VW_NEW_PRODUCT_SRC (
    PRD_ID,
    PRD_KEY,
    PRD_NM,
    CAT,
    SUBCAT,
    PRD_PRICE,
    DWH_STATUS,
    DWH_START_DATE,
    DWH_END_DATE,
    DWH_CREATE_DATE
)
AS
    SELECT 
        PRI.PRD_ID,
        PRI.PRD_KEY,
        PRI.PRD_NM,
        PX.CAT,
        PX.SUBCAT,
        PRI.PRD_PRICE,
        'Current' AS DWH_STATUS,
        CAST(GETDATE() AS DATE) AS DWH_START_DATE,
        '9999-12-31' AS DWH_END_DATE,
        GETDATE() AS DWH_CREATE_DATE
    FROM SILVER.CRM_PRD_INFO AS PRI
        LEFT JOIN SILVER.ERP_PX_CAT_G1V2 AS PX
        ON PRI.PRD_KEY = PX.ID;

        
